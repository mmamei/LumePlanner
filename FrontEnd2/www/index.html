<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <title>LumePlanner</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="js/global.js"></script>
        <script src="js/jquery.md5.js"></script>

        <style>
            .bg-blue {
                background-color: #084265;
                color: #ffffff;
            }
            .panel-heading {
                margin-bottom: 50px;
            }
            .img-responsive {
                margin: 0 auto;
            }
        </style>

        <script>
            $(document).ready(function(){

                // login user
                var user = window.sessionStorage.getItem("user");
                if(!user) {
                    console.log("user must be created");
                    var r = ""+Math.random();
                    user = {id: "", email: r, password: r};
                    console.log(user);
                    $.postJSON(conf.dita_server+"signup",user,
                            function(data, status){
                                console.log("Data: " + data + "\nStatus: " + status);
                                if (data === "true" || data === true) {
                                    console.log("registration succedded");
                                    window.sessionStorage.setItem("user",JSON.stringify(user))
                                }
                                else console.log("registration failed");

                            });
                }
                else {
                    user = JSON.parse(user);
                }
                // login was used only to retrieve an existing unfinished plan.
                // for now, we just remove it



                //console.log("user: "+window.localStorage.getItem("hashed_user"));
                $("img").click(function(event) {

                    console.log("the user selected "+event.target.id);


                    // update city
                    if(window.sessionStorage.getItem("city") !== event.target.id) {
                        console.log("update city");

                        var city = event.target.id;
                        window.sessionStorage.setItem("city", event.target.id);
                        window.sessionStorage.setItem("spois",JSON.stringify(new POIS()));

                        var pois = new POIS();

                        console.log("get activities for city "+city+" from server");

                        $.getJSON(conf.dita_server + 'activities?city=' + city,
                                function (data, status) {
                                    //console.log("Data: " + data + "\nStatus: " + status);
                                    data.forEach(function (value) {
                                        switch (value.category) {
                                            case "attractions":
                                                pois.attractions.push(value);
                                                break;
                                            case "monuments" :
                                                pois.monuments.push(value);
                                                break;
                                            case "museums" :
                                                pois.museums.push(value);
                                                break;
                                            case "eating" :
                                                pois.restaurants.push(value);
                                                break;
                                            case "parks" :
                                                pois.parks.push(value);
                                                break;
                                            case "resting" :
                                                pois.hotels.push(value);
                                                break;
                                            case "historical_sites" :
                                                pois.historical.push(value);
                                                break;
                                            case "religious_sites" :
                                                pois.religious.push(value);
                                                break;
                                            default :
                                                console.log("Invalid category:" + value.category);
                                        }
                                    });

                                    window.sessionStorage.setItem("pois",JSON.stringify(pois));
                                    var departure = window.sessionStorage.getItem("departure");
                                    var arrival = window.sessionStorage.getItem("arrival");
                                    window.location.href = "map.html";
                        });
                    }
                    else {
                        window.location.href = "map.html";
                    }


                });

            });
        </script>

    </head>
    <body class="bg-blue">
        <div class="container-fluid text-center panel-heading">
        <h1>Choose a City</h1>
        </div>
        <div class="container-fluid text-center">
            <h2>Bologna</h2>
            <img src="img/cities/bologna.jpg" class="img-responsive img-rounded" alt="bologna" id="Bologna">
        </div>
        <div class="container-fluid text-center">
            <h2>Modena</h2>
            <img src="img/cities/modena.jpg" class="img-responsive img-rounded" alt="modena" id="Modena" >
        </div>
        <div class="container-fluid text-center">
            <h2>Reggio Emilia</h2>
            <img src="img/cities/reggio.jpg" class="img-responsive img-rounded" alt="reggioemilia" id="ReggioEmilia">
        </div>
        <div class="container-fluid text-center">
            <h2>Parma</h2>
            <img src="img/cities/parma.jpg" class="img-responsive img-rounded" alt="parma" id="Parma">
        </div>
        <div class="container-fluid text-center">
            <h2>Ferrara</h2>
            <img src="img/cities/ferrara.jpg" class="img-responsive img-rounded" alt="ferrara" id="Ferrara">
        </div>
    </body>
</html>
