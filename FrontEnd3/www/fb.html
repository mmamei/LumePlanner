<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OpenFB Sample</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.min.css">
    <link rel="stylesheet" href="assets/css/jqm-demos.css">
	<link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css">
	
	<style>
		#login_btn{
		color:white;
		background-color: #4C69BA; !important
		}
		#logout_btn{
		color:white;
		background-color: #4C69BA; !important
		}
		#userPic{
		border-radius: 50%;
		display: block;
		margin-left: auto;
		margin-right: auto;
		}
		.ui-content{
		font-size:22px; !important
		}
		#div_img{
		height: 100px;
		}
		
	</style>

    <script src="js/jquery.min.js"></script>
    <script src="assets/js/modernizr-custom.js"></script>
    <script src="assets/js/index.js"></script>
    <script src="js/global.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <!--<script src="js/main/index.js"></script>-->
</head>
<body>

<div data-role="page" id = "pageone" class="jqm-demos jqm-home">

	<div data-role="header" class="jqm-header"  data-position="fixed" >
			<h2><img src="assets/img/logo-text.png" alt="jQuery Mobile"></h2>
			<!--<p>Version <span class="jqm-version"></span></p> -->
			<a href="" class="jqm-navmenu-link ui-btn ui-btn-icon-notext ui-corner-all ui-icon-bars ui-nodisc-icon ui-alt-icon ui-btn-left">Menu</a>
	</div>

	<div class="content content-padded">
		<div data-role="panel" class="jqm-navmenu-panel" data-position="left" data-display="overlay" data-theme="a">
			<ul class="jqm-list ui-alt-icon ui-nodisc-icon">
				<li data-filtertext="homepage" data-icon="home"><a href="index.html" tkey="homepage">Pagina principale</a></li>
				<li data-filtertext="luoghi" data-icon = "location"><a href="../myplaces/" data-icon="location" data-ajax="false" tkey="my_places">I miei luoghi</a></li>
				<li data-filtertext="viaggi" data-icon = "camera"><a href="../mytravels/" data-icon="location" data-ajax="false" tkey="my_itineraries">I miei viaggi</a></li>
				<li data-filtertext="percorsi" data-icon = "star"><a href="../favoritepath/" data-ajax="false" tkey="itineraries">I percorsi più visti</a></li>
				<li data-filtertext="account" data-icon = "user"><a href="fb.html" target="_top" data-ajax="false" tkey="user">Utente</a></li>
				<li data-filtertext="assistenza" data-icon = "phone"><a href="help.html" target="_top" data-ajax="false" tkey="help">Assistenza</a></li>
			</ul>
		</div>

		<div role="main" class="ui-content jqm-content">

			<div id="not_logged" style="display:none">		

				<p style="color:gray;text-align:center">Ciao!<br><br>Esegui il login tramite Facebook per avere nuove funzionalità</p>
			
				<button class="btn btn-block" id="login_btn" onclick="login()">Login  <i id="fb" class="fa fa-facebook-f"></i>acebook </button>
				<!--<button class="btn btn-block" onclick="myTok()">My token</button>-->
				
			</div>

			<div id="logged" style="display:none">

					<p style="color:gray;text-align:center">Ciao <span id="userName"></span>!<br><br>Grazie per aver eseguito il login tramite Facebook</p>
					
					<div id="div_img">
						<img id="userPic"/>
					</div>
					
					<button class="btn btn-block" id="logout_btn" onclick="logout()">Logout  <i id="fb" class="fa fa-facebook-f"></i>acebook </button>
					<button style="display: none;" class="btn btn-block" id="home_btn">Home</button>

					<!--<button class="btn btn-block" onclick="myTok()">My token</button>-->
					<!--<button class="btn btn-block" onclick="extendTok()">Extend</button>-->
					<!--<button class="btn btn-block" onclick="getInfo()">Get My Info</button>-->
					

					<p>Name: <span id="userName2"></span></p>
					<p>ID: <span id="userId"></span></p>
					<p>Birthday: <span id="userBirthday"></span></p>
					<p>Gender: <span id="userGender"></span></p>
					<p>Likes: <span id="userLikes"></span></p>
					<p>Eventi: <span id="events"></span></p>
					<img id="userPic"/>
					<hr/>

					<!--<textarea id="Message" placeholder="What's on your mind?" rows="5"></textarea>
					<button class="btn btn-block" onclick="share()">Share</button>-->
			</div>
		</div>
	</div>
</div>

<!--cordova.js is automatically injected by the Cordova build process-->
<script src="cordova.js"></script>

<script src="js/openfb.js"></script>

<script>

	function myTok() {
    alert(localStorage.getItem("fbAccessToken"))
    }

     //openFB.init({appId: '144640029403557'});
     // Defaults to sessionStorage for storing the Facebook token

    //  Uncomment the line below to store the Facebook token in localStorage instead of sessionStorage
      openFB.init({appId: '144640029403557', tokenStore: window.localStorage});

    function login() {
        openFB.login(
                function(response) {
                    if(response.status === 'connected') {
                        //alert('Facebook login succeeded, got access token: ' + response.authResponse.accessToken);
						location.reload();
                    } else {
                        alert('Facebook login failed: ' + response.error);
                    }
                }, {scope: 'email,user_birthday,user_likes,publish_actions'});
    }

    function getInfo() {
        openFB.api({
            path: '/me',
            params: {
                fields: "birthday,gender,first_name,last_name,id,likes.limit(200){about,category,name}"
            },
            success: function(data) {


				all.id = JSON.parse(window.localStorage.getItem("user")).email;
				all.generalInfo = data;
				all.eventsInfo = [];


                document.getElementById("userLikes").innerHTML = "<ul>";
				idLikes = [];
                idPlace = [];
                for(var i=0; i<data.likes["data"].length; i++){
              	 		document.getElementById("userLikes").innerHTML += "<li>"+ (i+1) + ") " + data.likes["data"][i]["name"] + " (" + data.likes["data"][i]["category"] + ") info: " + data.likes["data"][i]["about"];
                        idLikes.push(data.likes["data"][i]["id"])
                        }
                for(var i=0; i<idLikes.length; i++)
                	findEvent(idLikes[i],all);


                document.getElementById("userLikes").innerHTML += "</ul>";
                document.getElementById("userName").innerHTML = data.first_name + " " + data.last_name;
				document.getElementById("userName2").innerHTML = data.first_name + " " + data.last_name;
                document.getElementById("userId").innerHTML = data.id;
                document.getElementById("userGender").innerHTML = data.gender;
                document.getElementById("userBirthday").innerHTML = data.birthday;
                document.getElementById("userPic").src = 'http://graph.facebook.com/' + data.id + '/picture?type=small';
            },
            error: errorHandler});
    }



    function share() {
        openFB.api({
            method: 'POST',
            path: '/me/feed',
            params: {
                message: "Grazie mille LUME!!!",
				link: "www.bizzinidavide.altervista.org" 
            },
            success: function() {
                alert('the item was posted on Facebook');
            },
            error: errorHandler});
    }
	

function findEvent(id,all) {
        openFB.api({
            path: "/"+ id + "/events",
            params: {
            	fields: "name,place,start_time,end_time",
                limit: 100000
            },
            success: function(data) {
            	var doc = document.getElementById("events");
                doc.innerHTML += "<ul>";
            	//console.log(data)
                if(data["data"]["length"] != 0) 
                	for (var i=0 ; i<data["data"]["length"]; i++) {
                        var actualDate = new Date(formatLocalDate());
                        //console.log(actualDate)
                        var eventDate = new Date(data["data"][i]["start_time"]);
                    	//console.log(eventDate)
                       	if (eventDate-actualDate >=0) {
							all.eventsInfo.push(data["data"][i]);
                    		doc.innerHTML += "<li> " + data["data"][i]["name"] + " alle ore " + eventDate;
                        	if (data["data"][i]["place"]){
                				doc.innerHTML += "presso -> " + data["data"][i]["place"]["name"];
                                var place_id = data["data"][i]["place"]["id"];
                                doc.innerHTML += "<span id='" + place_id + "'></span>";
								if(place_id){
                                	findPlaceLoc(place_id)
                                    }
                            }
                        }        
                    } 
                doc.innerHTML += "</ul>"
            	},
            error: errorHandler});
            
    }

        function findPlaceLoc(id) {
        openFB.api({
            path: "/"+ id,
            params: {
            	fields: "location",
            },
            success: function(data) {
				//console.log(data)
                var doc = document.getElementById(data["id"]);
            	doc.innerHTML += " <b>lat</b> ->" + data["location"]["latitude"] + ", <b>long</b> -> " + data["location"]["longitude"]
            },
            error: errorHandler});
            
    } 
	

	    function extendTok() {
		var personalTok = localStorage.getItem("fbAccessToken");
        openFB.api({
            path: '/oauth/access_token',
            params: {
                grant_type: "fb_exchange_token",
				client_id: "144640029403557",
				client_secret: "edeb4fc2a84b0c903d1c8cdfc3de3f24",
				fb_exchange_token: personalTok
            },
            success: function(data) {
                //alert("estensione con successo")
				localStorage.setItem("fbAccessToken",data["access_token"])
            },
            error: errorHandler});
    }
 
    
function formatLocalDate() {
    var now = new Date(),
        tzo = -now.getTimezoneOffset(),
        dif = tzo >= 0 ? '+' : '-',
        pad = function(num) {
            var norm = Math.abs(Math.floor(num));
            return (norm < 10 ? '0' : '') + norm;
        };
    return now.getFullYear() 
        + '-' + pad(now.getMonth()+1)
        + '-' + pad(now.getDate())
        + 'T' + pad(now.getHours())
        + ':' + pad(now.getMinutes()) 
        + ':' + pad(now.getSeconds()) 
        + dif + pad(tzo / 60) 
        + ':' + pad(tzo % 60);
}    

	
	

    function readPermissions() {
        openFB.api({
            method: 'GET',
            path: '/me/permissions',
            success: function(result) {
                alert(JSON.stringify(result.data));
            },
            error: errorHandler
        });
    }

    function revoke() {
        openFB.revokePermissions(
                function() {
                    alert('Permissions revoked');
                },
                errorHandler);
    }

    function logout() {
        openFB.logout(
                function() {
                    //alert('Logout avvenuto con successo');
					location.reload();
                },
                errorHandler);
    }

    function errorHandler(error) {

		alert(error.message); //Invalid OAuth access token.
		localStorage.setItem("fbAccessToken","");
		location.reload()
    }


//MAIN
var all = {};
if(localStorage.getItem("fbAccessToken")!=null){
	getInfo();
	extendTok();
	document.getElementById("logged").style.display="";
	document.getElementById("not_logged").style.display="none";


	window.setTimeout(function(){
		//console.log("---------------------------")
		//console.log(all)
		$.postJSON(conf.dita_server+"fb",all,function(data, status){
			//alert(data)
			//alert(status)
			$("#home_btn").css("display","block")
		});
	},5000)


	}
else{
	document.getElementById("logged").style.display="none";
	document.getElementById("not_logged").style.display=""
	}

	$(document).ready(function(){
		$("#home_btn").click(function(){
			window.location = "index.html"
		})
	})

</script>
</body>
</html>
